#!/bin/bash

authkeys=.ssh/authorized_keys

pubkey=$HOME/.ssh/id_rsa.pub

while true; do
    case "$1" in
        -1)
            pubkey=$HOME/.ssh/identity.pub
            shift
            ;;
        -d)
            pubkey=$HOME/.ssh/id_dsa.pub
            shift
            ;;
        -f)
            pubkey="$2"
            shift; shift
            ;;
        -l)
            user="$2"
            shift; shift
            ;;
        *)
            break
            ;;
    esac
done

me=`basename $0`

usage () {
  cat <<EOF >&2
Usage: $me [options] [USER@]HOST
Options:
  -1   Use old ssh v1 keys
  -d   Use DSA key
EOF
  exit 1
}

if [ -z "$1" ] || [ "$1" == -h ] || [ "$1" == --help ]; then
  usage
fi

if ! [ -e "$pubkey" ]; then
  echo "$pubkey doesn't exist; aborting." >&2
  exit 1
fi

case "$pubkey" in
    *.pub)
        ;;
    *)
        echo "$pubkey doesn't end in '.pub'; aborting." >&2
        exit 1
        ;;
esac

for host in "$@"; do
  # quotes around last argument are necessary to allow
  # ssh-auth '-p 2263 root@localhost'
  # see http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=99785
  ssh-copy-id -i "$pubkey" "${user+$user@}$host"
done

# echo "Appending following keys from $pubkey to remote $authkeys:"
# awk '{print "  " $3}' $pubkey

# if ! ssh "$1" "mkdir -p .ssh; chmod 700 .ssh; cat >> $authkeys" < $pubkey; then
#   echo "ssh failed!" >&2
#   exit 1
# fi
