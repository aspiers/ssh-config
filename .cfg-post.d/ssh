#!/bin/bash

confdir=$HOME/.ssh
confsubdir=$confdir/config.d
config=$confdir/config

[ -d $confsubdir ] || mkdir -p $confsubdir
chmod go-rwx $confdir $confsubdir

# Ugh!
case "$BASH_VERSION" in
  1*)
    allow_null_glob_expansion=1
    ;;
  2*|3*)
    shopt -s nullglob
    ;;
  *)
    echo "Unknown \$BASH_VERSION $BASH_VERSION !  Aborting." >&2;
    exit 1
    ;;
esac

# dirents=`echo $confsubdir/*`
# [ -z "$dirents" ] && exit 0
# echo "parts $dirents"

magic_string="# Autogenerated from $0"
if [ -e $config ] && ! grep -q "^$magic_string" $config; then
    cat <<EOF >&2
Error: can't find '$magic_string' in $config
Presumably hand-written so won't overwrite; please break into parts.
EOF
    exit 1
fi

echo "# Rebuilding $config ..."

cat <<EOF > $config
# Autogenerated from $0 at `date`

EOF

$ZDOT_FIND_HOOKS .ssh/config.d | while read conf; do
  echo "#   Appending $conf"
  echo "# Include of $conf follows:" >> $config
  cat $conf >> $config
  echo >> $config
done
